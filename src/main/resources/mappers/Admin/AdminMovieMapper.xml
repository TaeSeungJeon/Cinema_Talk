<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="AdminMovieMapper"> <!-- 매퍼네임 스페이스명을 AdminMovieMapper로 설정 -->
  
   <!-- ============================= -->
    <!-- 1️⃣ 영화 존재 여부 확인 -->
    <!-- ============================= -->
    <select id="existsMovie" resultType="int">
        SELECT COUNT(*)
        FROM movie
        WHERE movieId = #{movieId}
    </select>

    <!-- ============================= -->
    <!-- 2️⃣ 영화 INSERT -->
    <!-- ============================= -->
    <insert id="insertMovie"
            parameterType="DTO.Movie.MovieDTO"
            useGeneratedKeys="true"
            keyProperty="movieId">

        INSERT INTO movie (
            movieTitle,
            movieOriginalTitle,
            movieOverview,
            movieReleaseDate,
            movieRuntime,
            moviePosterPath,
            movieBackdropPath,
            movieRatingAverage,
            movieRatingCount
        )
        VALUES (
            #{movieTitle},
            #{movieOriginalTitle},
            #{movieOverview},
            #{movieReleaseDate},
            #{movieRuntime},
            #{moviePosterPath},
            #{movieBackdropPath},
            #{movieRatingAverage},
            #{movieRatingCount}
        )
    </insert>

    <!-- ============================= -->
    <!-- 3️⃣ 영화 UPDATE -->
    <!-- ============================= -->
    <update id="updateMovie"
            parameterType="DTO.Movie.MovieDTO">

        UPDATE movie
        SET movieTitle = #{movieTitle},
            movieOriginalTitle = #{movieOriginalTitle},
            movieOverview = #{movieOverview},
            movieReleaseDate = #{movieReleaseDate},
            movieRuntime = #{movieRuntime},
            moviePosterPath = #{moviePosterPath},
            movieBackdropPath = #{movieBackdropPath},
            movieRatingAverage = #{movieRatingAverage},
            movieRatingCount = #{movieRatingCount}
        WHERE movieId = #{movieId}

    </update>

    <!-- ============================= -->
    <!-- 4️⃣ 장르 전체 삭제 -->
    <!-- ============================= -->
    <delete id="deleteMovieGenres">
        DELETE FROM movie_genre
        WHERE movieId = #{movieId}
    </delete>

    <!-- ============================= -->
    <!-- 5️⃣ 장르 INSERT -->
    <!-- ============================= -->
    <insert id="insertMovieGenre">
        INSERT INTO movie_genre (
            movieId,
            genreId
        )
        VALUES (
            #{movieId},
            #{genreId}
        )
    </insert>

    <!-- ============================= -->
    <!-- 6️⃣ 출연진 전체 삭제 -->
    <!-- ============================= -->
    <delete id="deleteMovieCasts">
        DELETE FROM movie_cast
        WHERE movieId = #{movieId}
    </delete>

    <!-- ============================= -->
    <!-- 7️⃣ 출연진 INSERT -->
    <!-- ============================= -->
    <insert id="insertMovieCast">
        INSERT INTO movie_cast (
            movieId,
            personId,
            characterName,
            castOrder
        )
        VALUES (
            #{movieId},
            #{personId},
            #{characterName},
            #{castOrder}
        )
    </insert>

    <!-- ============================= -->
    <!-- 8️⃣ 제작진 전체 삭제 -->
    <!-- ============================= -->
    <delete id="deleteMovieCrews">
        DELETE FROM movie_crew
        WHERE movieId = #{movieId}
    </delete>

    <!-- ============================= -->
    <!-- 9️⃣ 제작진 INSERT -->
    <!-- ============================= -->
    <insert id="insertMovieCrew">
        INSERT INTO movie_crew (
            movieId,
            personId,
            crewJob
        )
        VALUES (
            #{movieId},
            #{personId},
            #{crewJob}
        )
    </insert>
  
  </mapper>