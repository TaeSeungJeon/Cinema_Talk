<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MovieRecommend">

	<!-- 평점 20% + 회원 추천 80%로 인기 영화 List 반환 -->
	<select id="popularRec" resultType="MovieRecResponse">
		WITH stats AS (
			SELECT
				MIN(MOVIERATINGAVERAGE) AS minAvg,
				MAX(MOVIERATINGAVERAGE) AS maxAvg,
				MIN(MOVIERECOMMENDCOUNT) AS minRec,
				MAX(MOVIERECOMMENDCOUNT) AS maxRec
			FROM MOVIE
		),
		top_60_scored AS (
			SELECT
				M.MOVIEID,
				(
					0.2 * (M.MOVIERATINGAVERAGE - S.minAvg) / NULLIF(S.maxAvg - S.minAvg, 0)
					+ 0.8 * (M.MOVIERECOMMENDCOUNT - S.minRec) / NULLIF(S.maxRec - S.minRec, 0)
				) AS popularScore
			FROM MOVIE M
			CROSS JOIN stats S
			ORDER BY popularScore DESC
			FETCH FIRST 60 ROWS ONLY
		),
		shuffled AS (
			SELECT TS.MOVIEID
			FROM top_60_scored TS
			ORDER BY DBMS_RANDOM.VALUE
			FETCH FIRST #{MOVIESELECT} ROWS ONLY
		)
		SELECT
			M.MOVIEID AS movieId,
			M.MOVIETITLE AS movieTitle,
			M.MOVIEOVERVIEW AS movieOverview,
			M.MOVIERELEASEDATE AS movieReleaseDate,
			M.MOVIERUNTIME AS movieRuntime,
			M.MOVIEPOSTERPATH AS moviePosterPath,
			M.MOVIERATINGAVERAGE AS movieRatingAverage,
			M.MOVIERECOMMENDCOUNT AS movieRecommendCount,
			(SELECT LISTAGG(G.GENRENAME, ',') WITHIN GROUP (ORDER BY G.GENRENAME)
			 FROM MOVIE_GENRE MG
			 JOIN GENRE G ON G.GENREID = MG.GENREID
			 WHERE MG.MOVIEID = M.MOVIEID) AS genreName
		FROM MOVIE M
		JOIN shuffled S ON S.MOVIEID = M.MOVIEID
	</select>

	<!-- 회원의 선호 장르 아이디 추출 -->
	<select id="memLikeGenre" resultType="Integer">
		SELECT MG.GENREID
		FROM MEMBER_GENRE MG
		WHERE MG.MEMNO = #{memNo}
		ORDER BY MG.GENREID
	</select>

	<!-- 회원 선호 장르 기반 랜덤 영화 -->
	<select id="memLikeRec" resultType="MovieRecResponse">
		SELECT * FROM (
			SELECT
				M.MOVIEID AS movieId,
				M.MOVIETITLE AS movieTitle,
				M.MOVIEOVERVIEW AS movieOverview,
				M.MOVIERELEASEDATE AS movieReleaseDate,
				M.MOVIERUNTIME AS movieRuntime,
				M.MOVIEPOSTERPATH AS moviePosterPath,
				M.MOVIERATINGAVERAGE AS movieRatingAverage,
				M.MOVIERECOMMENDCOUNT AS movieRecommendCount,
				(SELECT LISTAGG(G.GENRENAME, ',') WITHIN GROUP (ORDER BY G.GENRENAME)
				 FROM MOVIE_GENRE MG2
				 JOIN GENRE G ON G.GENREID = MG2.GENREID
				 WHERE MG2.MOVIEID = M.MOVIEID) AS genreName
			FROM MOVIE M
			WHERE M.MOVIEID IN (
				SELECT DISTINCT MG.MOVIEID
				FROM MOVIE_GENRE MG
				WHERE MG.GENREID IN
				<foreach collection="likeGenreIds" item="gid" open="(" separator="," close=")">
					#{gid}
				</foreach>
			)
			ORDER BY DBMS_RANDOM.VALUE
		)
		WHERE ROWNUM &lt;= #{movieLimit}
	</select>

	<!-- 랜덤 장르 영화 추천 -->
	<select id="randomRec" resultType="MovieRecResponse">
		WITH randomGenres AS (
			SELECT genreId FROM (
				SELECT DISTINCT MG.GENREID AS genreId
				FROM MOVIE_GENRE MG
				ORDER BY DBMS_RANDOM.VALUE
			)
			WHERE ROWNUM &lt;= 3
		),
		randomMovieIds AS (
			SELECT movieId FROM (
				SELECT DISTINCT M.MOVIEID AS movieId
				FROM MOVIE M
				JOIN MOVIE_GENRE MG ON M.MOVIEID = MG.MOVIEID
				WHERE MG.GENREID IN (SELECT genreId FROM randomGenres)
				ORDER BY DBMS_RANDOM.VALUE
			)
			WHERE ROWNUM &lt;= #{movieLimit}
		)
		SELECT
			M.MOVIEID AS movieId,
			M.MOVIETITLE AS movieTitle,
			M.MOVIEOVERVIEW AS movieOverview,
			M.MOVIERELEASEDATE AS movieReleaseDate,
			M.MOVIERUNTIME AS movieRuntime,
			M.MOVIEPOSTERPATH AS moviePosterPath,
			M.MOVIEBACKDROPPATH AS movieBackdropPath,
			M.MOVIERATINGAVERAGE AS movieRatingAverage,
			M.MOVIERECOMMENDCOUNT AS movieRecommendCount,
			(SELECT LISTAGG(G.GENRENAME, ',') WITHIN GROUP (ORDER BY G.GENRENAME)
			 FROM MOVIE_GENRE MG2
			 JOIN GENRE G ON G.GENREID = MG2.GENREID
			 WHERE MG2.MOVIEID = M.MOVIEID) AS genreName
		FROM MOVIE M
		JOIN randomMovieIds RM ON RM.movieId = M.MOVIEID
	</select>

	<!-- 회원 선호 장르를 제외한 장르 추출 -->
	<select id="selRecGenre" parameterType="map" resultType="Integer">
		SELECT genreId FROM (
			SELECT G.GENREID AS genreId
			FROM GENRE G
			<where>
				<if test="likeGenre != null and likeGenre.size() > 0">
					G.GENREID NOT IN
					<foreach collection="likeGenre" item="id" open="(" separator="," close=")">
						#{id}
					</foreach>
				</if>
			</where>
			ORDER BY DBMS_RANDOM.VALUE
		)
		WHERE ROWNUM &lt;= #{genreLimit}
	</select>

	<!-- 입력된 장르를 기반으로 영화 선정 -->
	<select id="genreRec" parameterType="map" resultType="MovieRecResponse">
		WITH ranked AS (
			SELECT
				MG.GENREID AS genreId,
				G.GENRENAME AS sectionGenreName,
				M.MOVIEID AS movieId,
				M.MOVIERATINGCOUNT,
				ROW_NUMBER() OVER (PARTITION BY MG.GENREID ORDER BY M.MOVIERATINGCOUNT DESC) AS popularityRank
			FROM MOVIE M
			JOIN MOVIE_GENRE MG ON MG.MOVIEID = M.MOVIEID
			JOIN GENRE G ON G.GENREID = MG.GENREID
			WHERE MG.GENREID IN
			<foreach collection="genreIds" item="id" open="(" separator="," close=")">
				#{id}
			</foreach>
		),
		top100 AS (
			SELECT * FROM ranked WHERE popularityRank &lt;= 100
		),
		randomized AS (
			SELECT T.*, ROW_NUMBER() OVER (PARTITION BY T.genreId ORDER BY DBMS_RANDOM.VALUE) AS randomRank
			FROM top100 T
		),
		final20 AS (
			SELECT * FROM randomized WHERE randomRank &lt;= #{movieLimit}
		),
		dedup AS (
			SELECT * FROM (
				SELECT F.*, ROW_NUMBER() OVER (PARTITION BY F.movieId ORDER BY F.genreId) AS dupRank
				FROM final20 F
			)
			WHERE dupRank = 1
		)
		SELECT
			D.genreId,
			D.sectionGenreName,
			M.MOVIEID AS movieId,
			M.MOVIETITLE AS movieTitle,
			DBMS_LOB.SUBSTR(M.MOVIEOVERVIEW, 4000, 1) AS movieOverview,
			M.MOVIERELEASEDATE AS movieReleaseDate,
			M.MOVIERUNTIME AS movieRuntime,
			M.MOVIEPOSTERPATH AS moviePosterPath,
			M.MOVIERATINGAVERAGE AS movieRatingAverage,
			M.MOVIERECOMMENDCOUNT AS movieRecommendCount,
			(SELECT LISTAGG(G2.GENRENAME, ',') WITHIN GROUP (ORDER BY G2.GENRENAME)
			 FROM MOVIE_GENRE MG2
			 JOIN GENRE G2 ON MG2.GENREID = G2.GENREID
			 WHERE MG2.MOVIEID = M.MOVIEID) AS genreName
		FROM dedup D
		JOIN MOVIE M ON D.movieId = M.MOVIEID
		ORDER BY D.genreId, M.MOVIERATINGAVERAGE DESC
	</select>

	<!-- 인덱스 영화 추천 섹션: 랜덤 장르 7개 뽑고 장르당 영화 1개씩 -->
	<select id="indexGenreMovie" resultType="MovieRecResponse">
		<![CDATA[
		WITH candidateMovies AS (
			SELECT
				MG.GENREID AS genreId,
				G.GENRENAME AS genreName,
				M.MOVIEID AS movieId,
				ROW_NUMBER() OVER (
					PARTITION BY MG.GENREID
					ORDER BY CASE WHEN M.MOVIERATINGAVERAGE >= 8 THEN 1 ELSE 2 END, DBMS_RANDOM.VALUE
				) AS rn
			FROM MOVIE M
			JOIN MOVIE_GENRE MG ON MG.MOVIEID = M.MOVIEID
			JOIN GENRE G ON G.GENREID = MG.GENREID
			WHERE M.MOVIERATINGCOUNT >= 10
			  AND M.MOVIERATINGAVERAGE >= 6
			  AND M.MOVIEPOSTERPATH IS NOT NULL
		),
		pickedGenres AS (
			SELECT * FROM (
				SELECT DISTINCT genreId, genreName
				FROM candidateMovies
				ORDER BY DBMS_RANDOM.VALUE
			) WHERE ROWNUM <= 7
		),
		deduplicated AS (
			SELECT cm.*, ROW_NUMBER() OVER (PARTITION BY cm.movieId ORDER BY cm.rn ASC) AS movie_occurrence_rank
			FROM candidateMovies cm
			JOIN pickedGenres pg ON cm.genreId = pg.genreId
		),
		final_filter AS (
			SELECT * FROM (
				SELECT d.*, ROW_NUMBER() OVER (PARTITION BY d.genreId ORDER BY d.rn ASC) AS final_rank_in_genre
				FROM deduplicated d
				WHERE d.movie_occurrence_rank = 1
			) WHERE final_rank_in_genre = 1
		)
		SELECT
			M.MOVIEID AS movieId,
			M.MOVIETITLE AS movieTitle,
			M.MOVIEOVERVIEW AS movieOverview,
			M.MOVIERUNTIME AS movieRuntime,
			M.MOVIERATINGAVERAGE AS movieRatingAverage,
			M.MOVIEPOSTERPATH AS moviePosterPath,
			FF.genreName
		FROM final_filter FF
		JOIN MOVIE M ON FF.movieId = M.MOVIEID
		]]>
	</select>

	<!-- 인덱스 영화 배너: 7일 내 좋아요 TOP3 영화 -->
	<select id="indexTrendMovie" resultType="MovieRecResponse">
		WITH weeklyLikes AS (
			SELECT MR.movieId, COUNT(*) AS likeCount
			FROM MEMBER_MOVIE_RECOMMEND MR
			WHERE MR.RECOMMENDCREATEDAT &gt;= SYSDATE - 7
			GROUP BY MR.movieId
		),
		weeklyRanked AS (
			SELECT WL.movieId, WL.likeCount, ROW_NUMBER() OVER (ORDER BY WL.likeCount DESC) AS rn
			FROM weeklyLikes WL
		),
		weeklyTop AS (
			SELECT movieId, likeCount FROM weeklyRanked WHERE rn &lt;= 3
		),
		weeklyCount AS (
			SELECT COUNT(*) AS cnt FROM weeklyTop
		),
		fallbackRanked AS (
			SELECT M.MOVIEID AS movieId, M.MOVIERECOMMENDCOUNT AS likeCount
			FROM MOVIE M
			WHERE M.MOVIEPOSTERPATH IS NOT NULL
			  AND M.MOVIEBACKDROPPATH IS NOT NULL
			  AND M.MOVIERATINGCOUNT &gt;= 10
			  AND M.MOVIEID NOT IN (SELECT movieId FROM weeklyTop)
		),
		fallbackTop AS (
			SELECT movieId, likeCount FROM (
				SELECT FR.movieId, FR.likeCount, ROW_NUMBER() OVER (ORDER BY FR.likeCount DESC) AS rn2
				FROM fallbackRanked FR
			)
			WHERE rn2 &lt;= 3 - (SELECT cnt FROM weeklyCount)
		),
		combined AS (
			SELECT movieId, likeCount, 1 AS sortOrder FROM weeklyTop
			UNION ALL
			SELECT movieId, likeCount, 2 AS sortOrder FROM fallbackTop
		)
		SELECT
			M.MOVIEID AS movieId,
			M.MOVIETITLE AS movieTitle,
			M.MOVIEOVERVIEW AS movieOverview,
			M.MOVIERELEASEDATE AS movieReleaseDate,
			M.MOVIERUNTIME AS movieRuntime,
			M.MOVIEPOSTERPATH AS moviePosterPath,
			M.MOVIEBACKDROPPATH AS movieBackdropPath,
			M.MOVIERATINGAVERAGE AS movieRatingAverage,
			M.MOVIERECOMMENDCOUNT AS movieRecommendCount,
			(SELECT LISTAGG(G.GENRENAME, ',') WITHIN GROUP (ORDER BY G.GENRENAME)
			 FROM MOVIE_GENRE MG2
			 JOIN GENRE G ON G.GENREID = MG2.GENREID
			 WHERE MG2.MOVIEID = M.MOVIEID) AS genreName
		FROM combined T
		JOIN MOVIE M ON M.MOVIEID = T.movieId
		ORDER BY T.sortOrder, T.likeCount DESC
	</select>

</mapper>