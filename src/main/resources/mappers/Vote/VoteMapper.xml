<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="DAO.Vote.VoteDAO">

	<resultMap id="voteRegisterMap" type="voteregister">

		<id property="voteId" column="voteId" />
		<result property="voteTitle" column="voteTitle" />
		<result property="voteContent" column="voteContent" />
		<result property="voteStartDate" column="voteStartDate" />
		<result property="voteEndDate" column="voteEndDate" />
		<result property="voteStatus" column="voteStatus" />

		<collection property="optionList" ofType="voteoption">

			<id property="movieId" column="movieId" />
			<result property="voteId" column="voteId" />

			<result property="movieTitle" column="movieTitle" />
			<result property="movieReleaseDate"
				column="movieReleaseDate" />
			<result property="moviePosterPath"
				column="moviePosterPath" />

		</collection>

	</resultMap>
	<insert id="vrecIn" parameterType="voterecord">
		INSERT INTO vote_record
		values(recordIdSeq.nextval, sysdate, #{memNo}, #{voteId},
		#{movieId}, #{voteCommentText})
	</insert>

	<select id="vrecResult" resultType="voteresult"
		parameterType="int">
		SELECT
		    #{voteId} as voteId,
		    r.movieId,
		    
		    r.count,
		    r.totalVoterCount,
		    ROUND(r.count * 100.0 / r.totalCount, 1) AS percentage,
		    RANK() OVER (ORDER BY r.count DESC) AS rank,
		    m.movieTitle as movieTitle
		
		FROM (
		    SELECT
		        movieId,
		        count,
		        SUM(count) OVER() AS totalCount,
		        SUM(voterCnt) OVER() AS totalVoterCount
		    FROM (
		        SELECT
		            movieId,
		            COUNT(*) AS count,
		            COUNT(DISTINCT memNo) AS voterCnt
		        FROM vote_record
		        WHERE voteId = #{voteId}
		        GROUP BY movieId
		    )
		) r
		
		JOIN movie m
		ON r.movieId = m.movieId

	</select>

	<select id="vregList" resultType="voteregister">
		select * from vote_register

	</select>

	<select id="vregOne" resultType="voteregister">
		select * from vote_register
		where voteId=#{voteId}

	</select>

	<select id="vrecRecordAll" resultType="voterecord">
		select * from
		vote_record
	</select>

	<select id="vrecRecordMemno" resultType="voterecord">
		select * from
		vote_record where memNo=#{memNo} and voteId=#{voteId}
	</select>


	<update id="vrecUpdate">
		update vote_record set recordCreatedDate=sysdate,
		voteCommentText=#{voteCommentText} where memNo=#{memNo} and voteId =#{voteId}
	</update>

	<select id="vregFullList" resultMap="voteRegisterMap">

		SELECT
		vr.voteId,
		vr.voteTitle,
		vr.voteContent,
		TO_CHAR(vr.voteStartDate,'YYYY-MM-DD') AS voteStartDate,
		TO_CHAR(vr.voteEndDate,'YYYY-MM-DD') AS voteEndDate,
		vr.voteStatus,

		vo.movieId,

		m.movieTitle,
		TO_CHAR(m.movieReleaseDate,'YYYY-MM-DD') AS movieReleaseDate,
		m.moviePosterPath

		FROM vote_register vr
		JOIN vote_option vo ON vr.voteId = vo.voteId
		JOIN movie m ON vo.movieId = m.movieId

		ORDER BY vr.voteId, vo.movieId

	</select>

	<select id="vrecListVoteId" resultType="voterecord">
		SELECT 
	    vr.*, 
	    m.memName 
	FROM VOTE_RECORD vr
	JOIN MEMBER m ON vr.memNo = m.memNo
	WHERE vr.voteId = #{voteId}
	ORDER BY vr.recordId DESC
	</select>
	
	<select id="vregFullByVoteId" resultMap="voteRegisterMap">

		SELECT
		    vr.voteId,
		    vr.voteTitle,
		    vr.voteContent,
		    TO_CHAR(vr.voteStartDate,'YYYY-MM-DD') AS voteStartDate,
		    TO_CHAR(vr.voteEndDate,'YYYY-MM-DD') AS voteEndDate,
		    vr.voteStatus,
		    vo.movieId,
		    m.movieTitle,
		    TO_CHAR(m.movieReleaseDate,'YYYY-MM-DD') AS movieReleaseDate,
		    m.moviePosterPath
		FROM vote_register vr
		JOIN vote_option vo ON vr.voteId = vo.voteId
		JOIN movie m ON vo.movieId = m.movieId
		WHERE vr.voteId = #{voteId}
		ORDER BY vr.voteId, vo.movieId

	</select>
	
	<insert id="vregIn" parameterType="voteregister">
	<selectKey keyProperty="voteId" resultType="int" order="BEFORE">
        SELECT voteIdSeq.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO VOTE_REGISTER (
        voteId, voteTitle, voteContent, voteStartDate, voteEndDate, voteStatus
    ) VALUES (
        #{voteId}, #{voteTitle}, #{voteContent}, #{voteStartDate}, #{voteEndDate}, #{voteStatus}
    )
	</insert>
	
	<insert id="voptIn" parameterType="java.util.List">
	    INSERT ALL
	    <foreach collection="list" item="opt" separator=" ">
	        INTO VOTE_OPTION (voteId, movieId) VALUES (#{opt.voteId}, #{opt.movieId})
	    </foreach>
	    SELECT * FROM DUAL
	</insert>

	<update id="vregUpdate" parameterType="voteregister">
	UPDATE VOTE_REGISTER SET VOTETITLE=#{voteTitle}, votecontent=#{voteContent}, voteStartDate = #{voteStartDate}, voteEndDate = #{voteEndDate} where voteId=#{voteId}   
	</update>

	<delete id="voptDel" parameterType="voteregister">
	DELETE from vote_option where voteId=#{voteId}
	</delete>
	
	<delete id="vregDel" parameterType="voteregister">
	delete from vote_register where voteId=#{voteId}</delete>




</mapper>
