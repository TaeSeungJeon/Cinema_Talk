<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MovieRecommend">

  <!-- 평점 20% + 회원 추천 80%로 인기 영화 List 반환 -->
  <select id="popularRec" resultType="MovieRecResponse">
    WITH stats AS (
      SELECT
        MIN(MOVIERATINGAVERAGE)  AS minAvg,
        MAX(MOVIERATINGAVERAGE)  AS maxAvg,
        MIN(MOVIERECOMMENDCOUNT) AS minRec,
        MAX(MOVIERECOMMENDCOUNT) AS maxRec
      FROM MOVIE
    ),
    scored AS (
      SELECT
        M.MOVIEID          AS movieId,
        M.MOVIETITLE       AS movieTitle,
        M.MOVIEOVERVIEW    AS movieOverview,
        M.MOVIERELEASEDATE AS movieReleaseDate,
        M.MOVIERUNTIME     AS movieRuntime,
        M.MOVIEPOSTERPATH  AS moviePosterPath,
        (
          0.2 * (M.MOVIERATINGAVERAGE - S.minAvg) / NULLIF(S.maxAvg - S.minAvg, 0)
          + 0.8 * (M.MOVIERECOMMENDCOUNT - S.minRec) / NULLIF(S.maxRec - S.minRec, 0)
        ) AS popularScore
      FROM MOVIE M
      CROSS JOIN stats S
    ),
    oneGenre AS (
      SELECT movieId, genreId
      FROM (
        SELECT
          MG.MOVIEID AS movieId,
          MG.GENREID AS genreId,
          ROW_NUMBER() OVER (PARTITION BY MG.MOVIEID ORDER BY MG.GENREID) AS rn
        FROM MOVIE_GENRE MG
      )
      WHERE rn = 1
    )
    SELECT
      SC.movieId,
      SC.movieTitle,
      SC.movieOverview,
      SC.movieReleaseDate,
      SC.movieRuntime,
      SC.moviePosterPath,
      G.GENRENAME AS genreName
    FROM scored SC
    LEFT JOIN oneGenre OG ON OG.movieId = SC.movieId
    LEFT JOIN GENRE G ON G.GENREID = OG.genreId
    ORDER BY SC.popularScore DESC
    FETCH FIRST #{MOVIESELECT} ROWS ONLY
  </select>

  <!-- 회원의 선호 장르 아이디 추출 -->
  <select id="memLikeGenre" resultType="Integer">
    SELECT MG.GENREID
    FROM MEMBER_GENRE MG
    WHERE MG.MEMNO = #{mem_no}
    ORDER BY MG.GENREID
  </select>

  <!-- 회원 선호 장르 기반 랜덤 영화 -->
  <select id="memLikeRec" resultType="MovieRecResponse">
    SELECT
      T.movieId,
      T.movieTitle,
      T.movieOverview,
      T.movieReleaseDate,
      T.movieRuntime,
      T.moviePosterPath,
      T.genreName
    FROM (
      SELECT
        M.MOVIEID          AS movieId,
        M.MOVIETITLE       AS movieTitle,
        M.MOVIEOVERVIEW    AS movieOverview,
        M.MOVIERELEASEDATE AS movieReleaseDate,
        M.MOVIERUNTIME     AS movieRuntime,
        M.MOVIEPOSTERPATH  AS moviePosterPath,
        (
          SELECT G.GENRENAME
          FROM MOVIE_GENRE MG2
          JOIN GENRE G ON G.GENREID = MG2.GENREID
          WHERE MG2.MOVIEID = M.MOVIEID
          ORDER BY MG2.GENREID
          FETCH FIRST 1 ROWS ONLY
        ) AS genreName
      FROM MOVIE M
      WHERE EXISTS (
        SELECT 1
        FROM MOVIE_GENRE MG
        WHERE MG.MOVIEID = M.MOVIEID
          AND MG.GENREID IN
          <foreach collection="likeGenreIds" item="gid" open="(" separator="," close=")">
            #{gid}
          </foreach>
      )
      ORDER BY DBMS_RANDOM.VALUE
    ) T
    WHERE ROWNUM &lt;= #{movieLimit}
  </select>

  <!-- 회원 선호 장르를 제외한 장르 추출 -->
  <select id="selGenre" parameterType="map" resultType="Integer">
    SELECT genreId
    FROM (
      SELECT G.GENREID AS genreId
      FROM GENRE G
      <where>
        <if test="likeGenre != null and likeGenre.size() > 0">
          G.GENREID NOT IN
          <foreach collection="likeGenre" item="id" open="(" separator="," close=")">
            #{id}
          </foreach>
        </if>
      </where>
      ORDER BY DBMS_RANDOM.VALUE
    )
    WHERE ROWNUM &lt;= #{genreLimit}
  </select>

  <!-- 입력된 장르를 기반으로 영화 선정 -->
  <select id="genreRec" resultType="MovieRecResponse">
    SELECT
      T.movieId,
      T.movieTitle,
      T.movieOverview,
      T.movieReleaseDate,
      T.movieRuntime,
      T.moviePosterPath,
      T.genreName
    FROM (
      SELECT
        M.MOVIEID          AS movieId,
        M.MOVIETITLE       AS movieTitle,
        M.MOVIEOVERVIEW    AS movieOverview,
        M.MOVIERELEASEDATE AS movieReleaseDate,
        M.MOVIERUNTIME     AS movieRuntime,
        M.MOVIEPOSTERPATH  AS moviePosterPath,
        G.GENRENAME        AS genreName
      FROM MOVIE M
      JOIN MOVIE_GENRE MG ON MG.MOVIEID = M.MOVIEID
      JOIN GENRE G ON G.GENREID = MG.GENREID
      WHERE MG.GENREID = #{genreId}
      ORDER BY M.MOVIERATINGCOUNT DESC
    ) T
    WHERE ROWNUM &lt;= #{movieLimit}
  </select>

  <!-- 인덱스: 랜덤 장르 7개 뽑고 장르당 영화 1개씩 -->
  <select id="indexGenreMovie" resultType="MovieRecResponse">
    WITH pickedGenres AS (
      SELECT genreId
      FROM (
        SELECT DISTINCT G.GENREID AS genreId
        FROM GENRE G
        JOIN MOVIE_GENRE MG ON MG.GENREID = G.GENREID
        JOIN MOVIE M ON M.MOVIEID = MG.MOVIEID
        WHERE M.MOVIEPOSTERPATH IS NOT NULL
          AND M.MOVIERATINGCOUNT &gt;= 10
        ORDER BY DBMS_RANDOM.VALUE
      )
      WHERE ROWNUM &lt;= 7
    ),
    oneMovie AS (
      SELECT
        PG.genreId        AS genreId,
        M.MOVIEID         AS movieId,
        M.MOVIETITLE      AS movieTitle,
        M.MOVIEOVERVIEW   AS movieOverview,
        M.MOVIERELEASEDATE AS movieReleaseDate,
        M.MOVIERUNTIME    AS movieRuntime,
        M.MOVIEPOSTERPATH AS moviePosterPath,
        ROW_NUMBER() OVER (PARTITION BY PG.genreId ORDER BY DBMS_RANDOM.VALUE) AS rn
      FROM pickedGenres PG
      JOIN MOVIE_GENRE MG ON MG.GENREID = PG.genreId
      JOIN MOVIE M ON M.MOVIEID = MG.MOVIEID
      WHERE M.MOVIEPOSTERPATH IS NOT NULL
        AND M.MOVIERATINGCOUNT &gt;= 10
    )
    SELECT
      OM.movieId,
      OM.movieTitle,
      OM.movieOverview,
      OM.movieReleaseDate,
      OM.movieRuntime,
      OM.moviePosterPath,
      G.GENRENAME AS genreName
    FROM oneMovie OM
    JOIN GENRE G ON G.GENREID = OM.genreId
    WHERE OM.rn = 1
  </select>

</mapper>
