<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="BoardSearch">

    <!-- ============================================== -->
    <!-- 게시글 검색 카운트 (searchOption에 따라 동적 분기) -->
    <!-- ============================================== -->
    <select id="boardCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM BOARD
        WHERE 1=1
        <if test="type != 0">
            AND BOARDTYPE = #{type}
        </if>
        <choose>
            <!-- searchOption 0: 제목 + 내용 검색 -->
            <when test="searchOption == 0">
                AND (
                <foreach collection="wordList" item="word" separator="OR">
                    (UPPER(BOARDTITLE) LIKE '%' || UPPER(#{word}) || '%'
                     OR UPPER(BOARDCONTENT) LIKE '%' || UPPER(#{word}) || '%')
                </foreach>
                )
            </when>
            <!-- searchOption 1: 제목 검색 -->
            <when test="searchOption == 1">
                AND (
                <foreach collection="wordList" item="word" separator="OR">
                    UPPER(BOARDTITLE) LIKE '%' || UPPER(#{word}) || '%'
                </foreach>
                )
            </when>
            <!-- searchOption 2: 내용 검색 -->
            <when test="searchOption == 2">
                AND (
                <foreach collection="wordList" item="word" separator="OR">
                    UPPER(BOARDCONTENT) LIKE '%' || UPPER(#{word}) || '%'
                </foreach>
                )
            </when>
            <!-- searchOption 3: 작성자 검색 -->
            <when test="searchOption == 3">
                AND (
                <foreach collection="wordList" item="word" separator="OR">
                    UPPER(BOARDNAME) LIKE '%' || UPPER(#{word}) || '%'
                </foreach>
                )
            </when>
        </choose>
    </select>

    <!-- ============================================== -->
    <!-- 제목 + 내용 검색 (searchOption = 0) 페이징 -->
    <!-- ============================================== -->
    <select id="searchBoardByTitleAndCont" parameterType="map" resultType="bdto">
        SELECT *
        FROM (SELECT ROWNUM rnum, b.*
              FROM (SELECT b.*,
                           (SELECT COUNT(*)
                            FROM BOARD_LIKE l
                            WHERE l.boardId = b.boardId
                              AND l.boardType = b.boardType) AS likeCount
                    FROM BOARD b
                    WHERE 1=1
                      <if test="type != 0">
                          AND b.BOARDTYPE = #{type}
                      </if>
                      AND (
                        <foreach collection="wordList" item="word" separator="OR">
                            (UPPER(b.BOARDTITLE) LIKE '%' || UPPER(#{word}) || '%'
                             OR UPPER(b.BOARDCONTENT) LIKE '%' || UPPER(#{word}) || '%')
                        </foreach>
                      )
                    ORDER BY b.boardId DESC) b
              WHERE ROWNUM <![CDATA[<=]]> #{endrow})
        WHERE rnum >= #{startrow}
    </select>

    <!-- ============================================== -->
    <!-- 제목 검색 (searchOption = 1) 페이징 -->
    <!-- ============================================== -->
    <select id="searchBoardByTitle" parameterType="map" resultType="bdto">
        SELECT *
        FROM (SELECT ROWNUM rnum, b.*
              FROM (SELECT b.*,
                           (SELECT COUNT(*)
                            FROM BOARD_LIKE l
                            WHERE l.boardId = b.boardId
                              AND l.boardType = b.boardType) AS likeCount
                    FROM BOARD b
                    WHERE 1=1
                      <if test="type != 0">
                          AND b.BOARDTYPE = #{type}
                      </if>
                      AND (
                        <foreach collection="wordList" item="word" separator="OR">
                            UPPER(b.BOARDTITLE) LIKE '%' || UPPER(#{word}) || '%'
                        </foreach>
                      )
                    ORDER BY b.boardId DESC) b
              WHERE ROWNUM <![CDATA[<=]]> #{endrow})
        WHERE rnum >= #{startrow}
    </select>

    <!-- ============================================== -->
    <!-- 내용 검색 (searchOption = 2) 페이징 -->
    <!-- ============================================== -->
    <select id="searchBoardByCont" parameterType="map" resultType="bdto">
        SELECT *
        FROM (SELECT ROWNUM rnum, b.*
              FROM (SELECT b.*,
                           (SELECT COUNT(*)
                            FROM BOARD_LIKE l
                            WHERE l.boardId = b.boardId
                              AND l.boardType = b.boardType) AS likeCount
                    FROM BOARD b
                    WHERE 1=1
                      <if test="type != 0">
                          AND b.BOARDTYPE = #{type}
                      </if>
                      AND (
                        <foreach collection="wordList" item="word" separator="OR">
                            UPPER(b.BOARDCONTENT) LIKE '%' || UPPER(#{word}) || '%'
                        </foreach>
                      )
                    ORDER BY b.boardId DESC) b
              WHERE ROWNUM <![CDATA[<=]]> #{endrow})
        WHERE rnum >= #{startrow}
    </select>

    <!-- ============================================== -->
    <!-- 작성자 검색 (searchOption = 3) 페이징 -->
    <!-- ============================================== -->
    <select id="searchBoardByWriter" parameterType="map" resultType="bdto">
        SELECT *
        FROM (SELECT ROWNUM rnum, b.*
              FROM (SELECT b.*,
                           (SELECT COUNT(*)
                            FROM BOARD_LIKE l
                            WHERE l.boardId = b.boardId
                              AND l.boardType = b.boardType) AS likeCount
                    FROM BOARD b
                    WHERE 1=1
                      <if test="type != 0">
                          AND b.BOARDTYPE = #{type}
                      </if>
                      AND (
                        <foreach collection="wordList" item="word" separator="OR">
                            UPPER(b.BOARDNAME) LIKE '%' || UPPER(#{word}) || '%'
                        </foreach>
                      )
                    ORDER BY b.boardId DESC) b
              WHERE ROWNUM <![CDATA[<=]]> #{endrow})
        WHERE rnum >= #{startrow}
    </select>

    <!-- ============================================== -->
    <!-- 특정 영화의 게시글 카운트 -->
    <!-- ============================================== -->
    <select id="boardCountByMovieId" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM BOARD
        WHERE MOVIEID = #{movieId}
    </select>

    <!-- ============================================== -->
    <!-- 특정 영화의 게시글 목록 페이징 -->
    <!-- ============================================== -->
    <select id="boardListPageByMovieId" parameterType="map" resultType="bdto">
        SELECT *
        FROM (SELECT ROWNUM rnum, b.*
              FROM (SELECT b.*,
                           (SELECT COUNT(*)
                            FROM BOARD_LIKE l
                            WHERE l.boardId = b.boardId
                              AND l.boardType = b.boardType) AS likeCount
                    FROM BOARD b
                    WHERE b.MOVIEID = #{movieId}
                    ORDER BY b.boardId DESC) b
              WHERE ROWNUM <![CDATA[<=]]> #{endrow})
        WHERE rnum >= #{startrow}
    </select>

</mapper>
