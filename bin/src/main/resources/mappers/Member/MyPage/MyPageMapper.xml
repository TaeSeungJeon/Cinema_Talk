<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="MyPage">

	<!-- 게시글 목록 조회 (회원번호 기준) -->
	<select id="getBoardListByMemNo" parameterType="int" resultType="DTO.Board.BoardDTO">
		SELECT boardId, boardType, boardTitle, boardContent, boardName, 
		       boardRecommendCount, boardDate, memNo, movieId
		FROM BOARD 
		WHERE memNo = #{memNo} 
		ORDER BY boardDate DESC
	</select>
	
	<!-- 게시글 수 조회 -->
	<select id="getBoardCountByMemNo" parameterType="int" resultType="int">
		SELECT COUNT(*) FROM BOARD WHERE memNo = #{memNo}
	</select>
	
	<!-- 댓글 목록 조회 (회원번호 기준) -->
	<select id="getCommentListByMemNo" parameterType="int" resultType="DTO.Board.CommentsDTO">
		SELECT c.commentsId, c.boardId, c.boardType, c.commentsContent, 
		       c.commentsName, c.commentsDate, c.commentsNo, c.memNo,
		       c.parentBoardNo, c.parentBoardId,
		       b.boardTitle as boardTitle
		FROM COMMENTS c
		LEFT JOIN BOARD b ON c.boardId = b.boardId
		WHERE c.memNo = #{memNo}
		ORDER BY c.commentsDate DESC
	</select>
	
	<!-- 댓글 수 조회 -->
	<select id="getCommentCountByMemNo" parameterType="int" resultType="int">
		SELECT COUNT(*) FROM COMMENTS WHERE memNo = #{memNo}
	</select>
	
	<!-- 투표 참여 목록 조회 (회원번호 기준) -->
	<select id="getVoteRecordListByMemNo" parameterType="int" resultType="DTO.Vote.VoteRecordDTO">
		SELECT vr.recordId, vr.recordCreatedDate, vr.memNo, vr.voteId, 
		       vr.movieId, vr.voteCommentText,
		       vreg.voteTitle as voteTitle,
		       vreg.voteEndDate as voteEndDate,
		       m.movieTitle as movieTitle
		FROM VOTE_RECORD vr
		LEFT JOIN VOTE_REGISTER vreg ON vr.voteId = vreg.voteId
		LEFT JOIN MOVIE m ON vr.movieId = m.movieId
		WHERE vr.memNo = #{memNo}
		ORDER BY vr.recordCreatedDate DESC
	</select>
	
	<!-- 투표 참여 수 조회 -->
	<select id="getVoteCountByMemNo" parameterType="int" resultType="int">
		SELECT COUNT(DISTINCT voteId) FROM VOTE_RECORD WHERE memNo = #{memNo}
	</select>
	
	<!-- 회원 정보 수정 -->
	<update id="updateMemberInfo" parameterType="member">
        UPDATE MEMBER
        SET memName = #{memName},
            memPhone = #{memPhone},
            memEmail = #{memEmail},
            memPwd = #{memPwd},
            memId = #{memId}
        WHERE memNo = #{memNo}
    </update>
    
    <!-- 작성 게시글의 댓글 수 확인 -->
    <select id="getBoardCommentsCount" parameterType="int" resultType="int">
        SELECT COUNT(commentsId) FROM COMMENTS WHERE boardId = #{boardId}
    </select>
    
    <!-- 투표 댓글 목록 조회 (회원번호 기준, 댓글이 있는 것만) -->
    <select id="getVoteCommentListByMemNo" parameterType="int" resultType="DTO.Vote.VoteRecordDTO">
        SELECT vr.recordId, vr.recordCreatedDate, vr.memNo, vr.voteId,
               vr.movieId, vr.voteCommentText,
               vreg.voteTitle AS voteTitle,
               vreg.voteEndDate AS voteEndDate,
               m.movieTitle AS movieTitle
        FROM VOTE_RECORD vr
        LEFT JOIN VOTE_REGISTER vreg ON vr.voteId = vreg.voteId
        LEFT JOIN MOVIE m ON vr.movieId = m.movieId
        WHERE vr.memNo = #{memNo}
          AND vr.voteCommentText IS NOT NULL
        ORDER BY vr.recordCreatedDate DESC
    </select>
    
    <!-- 좋아요 표시한 영화 목록 조회 (MEMBER_MOVIE_RECOMMEND 기준) -->
    <select id="getLikedMoviesByMemNo" parameterType="int" resultType="DTO.Movie.MovieDTO">
        SELECT m.movieId, m.movieTitle, m.moviePosterPath, 
               m.movieRatingAverage, m.movieRecommendCount
        FROM MEMBER_MOVIE_RECOMMEND r
        JOIN MOVIE m ON r.movieId = m.movieId
        WHERE r.memNo = #{memNo}
        ORDER BY r.recommendCreatedAt DESC
    </select>
    
    <!-- 좋아요 표시한 게시글 목록 조회 (BOARD_LIKE 기준) -->
    <select id="getLikedBoardsByMemNo" parameterType="int" resultType="DTO.Board.BoardDTO">
        SELECT b.boardId, b.boardType, b.boardTitle, b.boardName, 
               b.boardRecommendCount, b.boardDate
        FROM BOARD_LIKE bl
        JOIN BOARD b ON bl.boardId = b.boardId AND bl.boardType = b.boardType
        WHERE bl.memNo = #{memNo}
        ORDER BY b.boardDate DESC
    </select>
    
    <!-- 전체 장르 목록 조회 -->
    <select id="getAllGenres" resultType="DTO.Movie.GenreDTO">
        SELECT genreId, genreName FROM GENRE ORDER BY genreName
    </select>
    
    <!-- 회원의 선호 장르 ID 목록 조회 -->
    <select id="getPreferredGenreIds" parameterType="int" resultType="int">
        SELECT genreId FROM MEMBER_GENRE WHERE memNo = #{memNo}
    </select>
    
    <!-- 회원의 선호 장르 전체 삭제 -->
    <delete id="deletePreferredGenres" parameterType="int">
        DELETE FROM MEMBER_GENRE WHERE memNo = #{memNo}
    </delete>
    
    <!-- 회원 선호 장르 1건 추가 -->
    <insert id="insertPreferredGenre" parameterType="map">
        INSERT INTO MEMBER_GENRE (genreId, memNo) VALUES (#{genreId}, #{memNo})
    </insert>
    
</mapper>