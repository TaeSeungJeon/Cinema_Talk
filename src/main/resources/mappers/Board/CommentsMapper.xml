<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Comments">
    <insert id="commentsIn" parameterType="cdto">
        INSERT INTO COMMENTS (
            COMMENTSID, BOARDID, BOARDTYPE, COMMENTSCONTENT,
            COMMENTSNAME, COMMENTSDATE, COMMENTSNO, MEMNO,
            PARENTBOARDNO, PARENTBOARDID
        ) VALUES (
                     SEQ_COMMENTS.NEXTVAL, #{boardId}, #{boardType}, #{commentsContent},
                     #{commentsName}, SYSDATE, #{commentsNo}, #{memNo},
                     #{parentBoardNo, jdbcType=INTEGER}, #{parentBoardId, jdbcType=INTEGER}
                 )
    </insert>

    <select id="commentsList" parameterType="int" resultType="cdto">
        SELECT *
        FROM COMMENTS
        WHERE BOARDID = #{boardId}
            START WITH PARENTBOARDID IS NULL
            CONNECT BY PRIOR COMMENTSID = PARENTBOARDID
        ORDER SIBLINGS BY COMMENTSID ASC
    </select>
    <!-- 댓글 수정 -->
    <update id="commentsUpdate" parameterType="cdto">
        UPDATE COMMENTS SET COMMENTSCONTENT = #{commentsContent}
        WHERE COMMENTSID = #{commentsId} AND MEMNO = #{memNo}
    </update>

    <delete id="deleteCommentLikesByCommentTree" parameterType="int">
        DELETE FROM COMMENTS_LIKE
        WHERE COMMENTSID IN (
            SELECT COMMENTSID
            FROM COMMENTS
            START WITH COMMENTSID = #{value}
            CONNECT BY PRIOR COMMENTSID = PARENTBOARDID
        )
    </delete>
    <!-- 댓글 삭제 -->
    <delete id="commentsDeleteTree" parameterType="map">
        DELETE FROM COMMENTS
        WHERE COMMENTSID IN (
            SELECT COMMENTSID
            FROM COMMENTS
            START WITH COMMENTSID = #{commentsId}
            CONNECT BY PRIOR COMMENTSID = PARENTBOARDID
        )
          AND #{memNo} = (SELECT MEMNO FROM COMMENTS WHERE COMMENTSID = #{commentsId})
    </delete>

    <!-- 댓글 좋아요 -->
    <insert id="commentsLikeInsert" parameterType="map">
        INSERT INTO COMMENTS_LIKE (commentsId, memNo)VALUES (#{commentsId}, #{memNo})
    </insert>

    <delete id="commentsLikeDelete" parameterType="map">
        DELETE FROM COMMENTS_LIKE
        WHERE commentsId = #{commentsId} AND memNo = #{memNo}
    </delete>

    <!-- 댓글 좋아요 개수 조회 -->
    <select id="commentsLikeCount" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM COMMENTS_LIKE
        WHERE commentsId = #{commentsId}
    </select>

    <!-- 사용자의 댓글 좋아요 여부 확인 -->
    <select id="commentsLikeCheck" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM COMMENTS_LIKE
        WHERE commentsId = #{commentsId} AND memNo = #{memNo}
    </select>

    <!-- 댓글 목록 조회 시 좋아요 정보 포함 -->
    <select id="commentsListWithLike" parameterType="map" resultType="cdto">
    SELECT c.*,
    (SELECT COUNT(*) FROM COMMENTS_LIKE cl WHERE cl.commentsId = c.commentsId) as likeCount,
    CASE WHEN #{memNo} IS NOT NULL THEN
    (SELECT COUNT(*) FROM COMMENTS_LIKE cl2 WHERE cl2.commentsId = c.commentsId AND cl2.memNo = #{memNo})
    ELSE 0 END as isLiked
    FROM COMMENTS c
    WHERE c.BOARDID = #{boardId}
    START WITH c.PARENTBOARDID IS NULL
    CONNECT BY PRIOR c.COMMENTSID = c.PARENTBOARDID
    ORDER SIBLINGS BY c.COMMENTSID ASC
    </select>


</mapper>